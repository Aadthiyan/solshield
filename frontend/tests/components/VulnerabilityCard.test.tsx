import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import VulnerabilityCard from '@/components/VulnerabilityCard';
import { VulnerabilityType, SeverityLevel } from '@/types';

describe('VulnerabilityCard', () => {
  const mockVulnerability: VulnerabilityType = {
    type: 'reentrancy',
    severity: 'high' as SeverityLevel,
    confidence: 0.85,
    description: 'Reentrancy vulnerability detected',
    location: 'Line 5: msg.sender.transfer(amount);',
    explanation: 'External call before state change',
    recommendation: 'Use checks-effects-interactions pattern',
    references: ['https://example.com/reentrancy'],
  };

  const defaultProps = {
    vulnerability: mockVulnerability,
    index: 0,
    onExpand: jest.fn(),
    isExpanded: false,
  };

  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('renders vulnerability information correctly', () => {
    render(<VulnerabilityCard {...defaultProps} />);
    
    expect(screen.getByText('reentrancy')).toBeInTheDocument();
    expect(screen.getByText('Reentrancy vulnerability detected')).toBeInTheDocument();
    expect(screen.getByText('85%')).toBeInTheDocument();
    expect(screen.getByText('Line 5: msg.sender.transfer(amount);')).toBeInTheDocument();
  });

  it('shows correct severity badge', () => {
    render(<VulnerabilityCard {...defaultProps} />);
    
    expect(screen.getByText('high')).toBeInTheDocument();
  });

  it('calls onExpand when clicked', async () => {
    const user = userEvent.setup();
    const mockOnExpand = jest.fn();
    
    render(<VulnerabilityCard {...defaultProps} onExpand={mockOnExpand} />);
    
    const card = screen.getByText('reentrancy').closest('div');
    await user.click(card!);
    
    expect(mockOnExpand).toHaveBeenCalledWith(0);
  });

  it('shows expanded content when isExpanded is true', () => {
    render(<VulnerabilityCard {...defaultProps} isExpanded={true} />);
    
    expect(screen.getByText('Technical Explanation')).toBeInTheDocument();
    expect(screen.getByText('External call before state change')).toBeInTheDocument();
    expect(screen.getByText('Recommendation')).toBeInTheDocument();
    expect(screen.getByText('Use checks-effects-interactions pattern')).toBeInTheDocument();
  });

  it('shows references when available', () => {
    render(<VulnerabilityCard {...defaultProps} isExpanded={true} />);
    
    expect(screen.getByText('References')).toBeInTheDocument();
    expect(screen.getByText('https://example.com/reentrancy')).toBeInTheDocument();
  });

  it('handles copy functionality', async () => {
    const user = userEvent.setup();
    
    // Mock clipboard API
    const mockWriteText = jest.fn();
    Object.assign(navigator, {
      clipboard: {
        writeText: mockWriteText,
      },
    });
    
    render(<VulnerabilityCard {...defaultProps} isExpanded={true} />);
    
    const copyButton = screen.getByText('Copy');
    await user.click(copyButton);
    
    expect(mockWriteText).toHaveBeenCalledWith('Line 5: msg.sender.transfer(amount);');
  });

  it('shows confidence level correctly', () => {
    render(<VulnerabilityCard {...defaultProps} isExpanded={true} />);
    
    expect(screen.getByText('Confidence Level')).toBeInTheDocument();
  });

  it('handles different severity levels', () => {
    const criticalVuln = { ...mockVulnerability, severity: 'critical' as SeverityLevel };
    
    render(<VulnerabilityCard {...defaultProps} vulnerability={criticalVuln} />);
    
    expect(screen.getByText('critical')).toBeInTheDocument();
  });

  it('handles missing optional fields', () => {
    const minimalVuln = {
      type: 'integer_overflow',
      severity: 'medium' as SeverityLevel,
      confidence: 0.6,
      description: 'Integer overflow detected',
    };
    
    render(<VulnerabilityCard {...defaultProps} vulnerability={minimalVuln} />);
    
    expect(screen.getByText('integer_overflow')).toBeInTheDocument();
    expect(screen.getByText('Integer overflow detected')).toBeInTheDocument();
    expect(screen.getByText('60%')).toBeInTheDocument();
  });

  it('shows correct confidence color based on level', () => {
    render(<VulnerabilityCard {...defaultProps} isExpanded={true} />);
    
    // High confidence should show green
    const confidenceBar = screen.getByRole('progressbar', { hidden: true });
    expect(confidenceBar).toHaveStyle('width: 85%');
  });

  it('handles expand/collapse animation', () => {
    const { rerender } = render(<VulnerabilityCard {...defaultProps} isExpanded={false} />);
    
    expect(screen.queryByText('Technical Explanation')).not.toBeInTheDocument();
    
    rerender(<VulnerabilityCard {...defaultProps} isExpanded={true} />);
    
    expect(screen.getByText('Technical Explanation')).toBeInTheDocument();
  });

  it('displays vulnerability type with proper formatting', () => {
    const vulnWithUnderscores = {
      ...mockVulnerability,
      type: 'integer_overflow',
    };
    
    render(<VulnerabilityCard {...defaultProps} vulnerability={vulnWithUnderscores} />);
    
    expect(screen.getByText('integer overflow')).toBeInTheDocument();
  });
});
